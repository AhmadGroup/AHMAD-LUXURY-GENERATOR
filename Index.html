import React, { useState, useEffect, useRef } from 'react';
import { Camera, Upload, Sparkles, User, Shirt, Palette, MapPin, Sliders, CheckCircle2, Loader2, Image as ImageIcon, Download, ShieldCheck, Users } from 'lucide-react';

const App = () => {
  const [activeTab, setActiveTab] = useState('identity');
  const [loading, setLoading] = useState(false);
  const [resultImage, setResultImage] = useState(null);
  const [userPhoto, setUserPhoto] = useState(null);
  const [partnerPhoto, setPartnerPhoto] = useState(null); 
  
  // State for parameters
  const [mode, setMode] = useState('Pria'); // Pria, Wanita, Pasangan
  const [params, setParams] = useState({
    upper: '',
    lower: '',
    layering: 'Tanpa Outer',
    headwear: '',
    headwearMotif: 'Polos',
    color: 'Champagne Gold',
    material: 'Silk Premium',
    shariaLevel: 'Full Syar’i',
    accessory: 'Tanpa Aksesoris',
    footwear: 'Pantofel Formal',
    framing: 'Full Body',
    angle: 'Menghadap Kamera',
    lens: '85mm (Prime Lens)',
    pose: 'Berdiri Formal Menghadap Kamera',
    background: 'Studio Mewah',
    lighting: 'Soft Light Cinematic'
  });

  const options = {
    Pria: {
      upper: ['Jubah', 'Baju Koko', 'Jasko', 'Gamis Pria', 'Thobe Arab', 'Kurta'],
      lower: ['Celana Kain Slim', 'Celana Sirwal', 'Sarung Modern'],
      headwear: ['Peci', 'Sorban', 'Kopiah', 'Turban', 'Imamah'],
      headwearMotif: ['Polos', 'Bordir Halus', 'Motif Islami', 'Tekstur Rajut'],
    },
    Wanita: {
      upper: ['Tunik Modern Loose', 'Abaya Elegan', 'Gamis Syar’i', 'Kaftan Modern', 'Dress Brokat'],
      lower: ['Rok A-Line', 'Rok Straight', 'Kain Lilit Batik', 'Celana Kulot Lebar'],
      headwear: ['Jilbab Instan Syar’i', 'Pashmina Dada', 'Hijab Segi Empat', 'Khimar Panjang', 'Niqab'],
      headwearMotif: ['Polos Silk', 'Motif Floral', 'Payet', 'Renda Halus', 'Plisket'],
    },
    Pasangan: {
      upper: ['Sarimbit Keluarga', 'Batik Couple', 'Gamis & Koko Senada', 'Abaya & Thobe Matching'],
      lower: ['Sesuai Tema Pasangan'],
      headwear: ['Peci & Hijab', 'Sorban & Khimar', 'Tanpa Tutup Kepala'],
      headwearMotif: ['Polos Senada', 'Motif Kembaran'],
    },
    Global: {
      colors: [
        'Champagne Gold', 'Terracotta', 'Putih Kristal', 'Hitam Silk', 'Emerald Green', 
        'Navy Blue', 'Mocca', 'Sage Green', 'Midnight Purple', 'Maroon Velvet', 
        'Charcoal Grey', 'Dusty Rose', 'Sand Beige', 'Royal Silver', 'Olive Green', 'Lavender Ash'
      ],
      materials: ['Silk Premium', 'Satin Mengkilap', 'Katun Halus', 'Bordir Eksklusif', 'Jacquard', 'Batik Parang', 'Wool Blend', 'Velvet Premium'],
      sharia: ['Modest Casual', 'Full Syar’i', 'Ultra Coverage'],
      accessories: ['Jam Tangan', 'Tas Kulit', 'Clutch', 'Tasbih', 'Bros Hijab', 'Tanpa Aksesoris'],
      footwear: ['Sepatu Formal Matching', 'Sandal Kulit Luxury', 'Pantofel & Heels'],
      backgrounds: ['Studio Mewah', 'Masjid Modern', 'Pelaminan Elegan', 'Taman Islami', 'Interior Rumah Mewah', 'Padang Pasir Luxury'],
      lighting: ['Soft Light Cinematic', 'Dramatic Lighting', 'Golden Hour', 'Studio Softbox'],
      poses: {
        Individu: [
          'Berdiri Formal Menghadap Kamera', 'Berdiri Sudut 3/4 Wibawa', 'Duduk Tenang', 'Senyum Lembut'
        ],
        Pasangan: [
          'Berdiri Berdampingan Mesra', 'Pria di Belakang Wanita (Potret Keluarga)', 
          'Berjalan Bersama Bergandengan', 'Duduk Bersama di Sofa Mewah', 'Saling Menatap Penuh Makna'
        ]
      }
    }
  };

  useEffect(() => {
    const genderKey = mode === 'Pasangan' ? 'Pasangan' : mode;
    setParams(prev => ({
      ...prev,
      upper: options[genderKey].upper[0],
      lower: options[genderKey].lower[0],
      headwear: options[genderKey].headwear[0],
      headwearMotif: options[genderKey].headwearMotif[0]
    }));
  }, [mode]);

  const handlePhotoUpload = (e, setter) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setter(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const downloadImage = () => {
    if (!resultImage) return;
    const link = document.createElement('a');
    link.href = resultImage;
    link.download = `AhmadLuxury_${mode}_${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const generateImage = async () => {
    // Validasi berdasarkan mode aktif
    if (mode === 'Pasangan') {
      if (!userPhoto || !partnerPhoto) {
        alert("Mode Pasangan: Harap unggah foto Pria DAN foto Wanita.");
        return;
      }
    } else {
      if (!userPhoto) {
        alert(`Mode ${mode}: Harap unggah foto wajah terlebih dahulu.`);
        return;
      }
    }

    setLoading(true);
    const apiKey = ""; 
    
    let subjectDescription = "";
    let faceInputs = [];

    // PENENTUAN INPUT BERDASARKAN MODE (FIXED LOGIC)
    if (mode === 'Pasangan') {
      subjectDescription = `A Muslim couple (one male and one female). 
        The MALE character's face must be IDENTICAL to Image 1. 
        The FEMALE character's face must be IDENTICAL to Image 2. 
        Maintain all distinct facial features of both individuals.`;
      
      faceInputs = [
        { inlineData: { mimeType: "image/png", data: userPhoto.split(',')[1] } },
        { inlineData: { mimeType: "image/png", data: partnerPhoto.split(',')[1] } }
      ];
    } else {
      // Mode Individu (Pria atau Wanita)
      subjectDescription = `A single ${mode.toLowerCase()} person. 
        The face must be 100% IDENTICAL to the provided Image. 
        Do not add any other person in the image. Single subject only.`;
      
      // Hanya kirim 1 foto meskipun state partnerPhoto mungkin ada isinya
      faceInputs = [
        { inlineData: { mimeType: "image/png", data: userPhoto.split(',')[1] } }
      ];
    }

    const prompt = `CRITICAL TASK: HIGH-FIDELITY FACE PRESERVATION.
      ${subjectDescription}
      Preserve jawlines, eye shapes, and original identity. 
      OUTPUT: Vertical Portrait (9:16).
      FASHION: High-end ${mode === 'Pasangan' ? 'Sarimbit/Matching' : ''} Islamic attire. ${params.upper}, ${params.lower}.
      STYLE: ${params.color} ${params.material}, ${params.shariaLevel}.
      DETAILS: ${params.headwear} with ${params.headwearMotif}.
      SCENE: ${params.background}, ${params.lighting}.
      POSE: ${mode === 'Pasangan' ? params.pose : params.pose}.
      TECHNICAL: Shot on 85mm lens, sharp focus on all faces, 8K UHD, photorealistic.`;

    try {
      let retryCount = 0;
      const maxRetries = 5;
      let success = false;

      while (retryCount < maxRetries && !success) {
        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: prompt },
                  ...faceInputs
                ]
              }],
              generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
            })
          });

          const result = await response.json();
          const base64Data = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          
          if (base64Data) {
            setResultImage(`data:image/png;base64,${base64Data}`);
            success = true;
          } else {
            throw new Error("Retry");
          }
        } catch (err) {
          retryCount++;
          await new Promise(res => setTimeout(res, Math.pow(2, retryCount) * 1000));
        }
      }
    } catch (error) {
      console.error(error);
      alert("Gagal memproses gambar.");
    } finally {
      setLoading(false);
    }
  };

  const SelectionGroup = ({ title, field, optionsList }) => (
    <div className="mb-4">
      <label className="block text-xs font-semibold uppercase tracking-wider text-zinc-500 mb-2">{title}</label>
      <div className="grid grid-cols-2 gap-2">
        {optionsList.map(opt => (
          <button
            key={opt}
            onClick={() => setParams({ ...params, [field]: opt })}
            className={`px-3 py-2 text-sm rounded-lg border transition-all ${
              params[field] === opt 
              ? 'bg-amber-600 border-amber-500 text-white shadow-lg' 
              : 'bg-zinc-800 border-zinc-700 text-gray-300 hover:border-zinc-500'
            }`}
          >
            {opt}
          </button>
        ))}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans p-4 md:p-8 flex flex-col items-center">
      <div className="w-full max-w-6xl">
        <header className="mb-8 border-b border-zinc-800 pb-6 flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold tracking-tight text-amber-500 flex items-center gap-2">
              <Sparkles className="w-6 h-6" />
              AHMAD LUXURY <span className="text-white font-light text-base ml-1">v6.1</span>
            </h1>
            <p className="text-zinc-500 text-sm italic">"Precision Mode - Identity Switcher"</p>
          </div>
          <div className="hidden md:flex items-center gap-2 bg-amber-900/10 px-4 py-2 rounded-full border border-amber-900/20">
             <ShieldCheck className="w-4 h-4 text-amber-500" />
             <span className="text-[10px] font-bold text-amber-500 uppercase tracking-wider">Face Lock Sync</span>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
          
          {/* Controls Panel */}
          <div className="lg:col-span-5 order-2 lg:order-1 bg-zinc-900/40 rounded-3xl border border-zinc-800 p-6 backdrop-blur-sm">
            <div className="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
              {[
                { id: 'identity', icon: User, label: 'Identitas' },
                { id: 'outfit', icon: Shirt, label: 'Busana' },
                { id: 'style', icon: Palette, label: 'Gaya' },
                { id: 'scene', icon: MapPin, label: 'Latar' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-full text-xs transition-all flex-shrink-0 ${
                    activeTab === tab.id ? 'bg-amber-600 text-white' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
                  }`}
                >
                  <tab.icon className="w-3.5 h-3.5" />
                  {tab.label}
                </button>
              ))}
            </div>

            <div className="space-y-6 max-h-[55vh] overflow-y-auto pr-2 custom-scrollbar">
              {activeTab === 'identity' && (
                <div className="space-y-6">
                   <div className="flex bg-zinc-800 p-1 rounded-2xl">
                    {['Pria', 'Wanita', 'Pasangan'].map(m => (
                      <button 
                        key={m} 
                        onClick={() => setMode(m)} 
                        className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${mode === m ? 'bg-amber-600 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}
                      >
                        {m === 'Pasangan' ? <Users className="w-3 h-3" /> : <User className="w-3 h-3" />}
                        {m}
                      </button>
                    ))}
                  </div>

                  <div className={`grid gap-4 ${mode === 'Pasangan' ? 'grid-cols-2' : 'grid-cols-1'}`}>
                    {/* Slot 1: Foto Utama */}
                    <div className="space-y-2">
                      <label className="text-[10px] text-zinc-500 uppercase font-bold text-center block">
                        {mode === 'Pasangan' ? 'Foto Pria' : `Foto ${mode}`}
                      </label>
                      <div className="relative group aspect-square rounded-2xl overflow-hidden border-2 border-dashed border-zinc-700 flex items-center justify-center hover:border-amber-500 transition-colors">
                        {userPhoto ? (
                          <img src={userPhoto} className="w-full h-full object-cover" />
                        ) : (
                          <Upload className="w-5 h-5 text-zinc-600" />
                        )}
                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handlePhotoUpload(e, setUserPhoto)} accept="image/*" />
                      </div>
                    </div>

                    {/* Slot 2: Muncul hanya di Mode Pasangan */}
                    {mode === 'Pasangan' && (
                      <div className="space-y-2">
                        <label className="text-[10px] text-zinc-500 uppercase font-bold text-center block">Foto Wanita</label>
                        <div className="relative group aspect-square rounded-2xl overflow-hidden border-2 border-dashed border-zinc-700 flex items-center justify-center hover:border-amber-500 transition-colors">
                          {partnerPhoto ? (
                            <img src={partnerPhoto} className="w-full h-full object-cover" />
                          ) : (
                            <Upload className="w-5 h-5 text-zinc-600" />
                          )}
                          <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handlePhotoUpload(e, setPartnerPhoto)} accept="image/*" />
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'outfit' && (
                <div className="space-y-4">
                  <SelectionGroup title="Tema Pakaian" field="upper" optionsList={options[mode === 'Pasangan' ? 'Pasangan' : mode].upper} />
                  {mode !== 'Pasangan' && <SelectionGroup title="Bawahan" field="lower" optionsList={options[mode].lower} />}
                  <SelectionGroup title="Penutup Kepala" field="headwear" optionsList={options[mode === 'Pasangan' ? 'Pasangan' : mode].headwear} />
                </div>
              )}

              {activeTab === 'style' && (
                <div className="space-y-4">
                  <SelectionGroup title="Warna Dominan" field="color" optionsList={options.Global.colors} />
                  <SelectionGroup title="Material Kain" field="material" optionsList={options.Global.materials} />
                  <SelectionGroup title="Kesyarian" field="shariaLevel" optionsList={options.Global.sharia} />
                </div>
              )}

              {activeTab === 'scene' && (
                <div className="space-y-4">
                  <SelectionGroup title="Pose Karakter" field="pose" optionsList={mode === 'Pasangan' ? options.Global.poses.Pasangan : options.Global.poses.Individu} />
                  <SelectionGroup title="Latar Belakang" field="background" optionsList={options.Global.backgrounds} />
                  <SelectionGroup title="Pencahayaan" field="lighting" optionsList={options.Global.lighting} />
                </div>
              )}
            </div>

            <div className="mt-8 flex gap-3">
              <button
                onClick={generateImage}
                disabled={loading}
                className={`flex-grow py-4 rounded-2xl flex items-center justify-center gap-3 font-bold transition-all ${
                  loading ? 'bg-zinc-800 text-zinc-600' : 'bg-amber-600 hover:bg-amber-500 text-white shadow-lg'
                }`}
              >
                {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Sparkles className="w-5 h-5" />}
                {loading ? 'Processing Faces...' : `Generate ${mode}`}
              </button>

              {resultImage && (
                <button
                  onClick={downloadImage}
                  className="px-6 py-4 bg-zinc-100 text-black rounded-2xl font-bold hover:bg-white transition-all flex items-center justify-center shadow-lg"
                  title="Simpan ke Galeri"
                >
                  <Download className="w-5 h-5" />
                </button>
              )}
            </div>
          </div>

          {/* Canvas Portrait 9:16 - Right */}
          <div className="lg:col-span-7 order-1 lg:order-2 flex flex-col items-center">
            <div className="relative">
              <div className="w-[300px] md:w-[380px] aspect-[9/16] bg-zinc-900 rounded-2xl shadow-[0_40px_80px_-15px_rgba(0,0,0,0.9)] overflow-hidden relative border border-white/5">
                {resultImage ? (
                  <img src={resultImage} alt="Design result" className="w-full h-full object-cover select-none" />
                ) : (
                  <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center bg-zinc-950/20">
                    {loading ? (
                      <div className="space-y-4">
                        <Loader2 className="w-12 h-12 text-amber-500 animate-spin mx-auto" />
                        <p className="text-amber-500 font-medium animate-pulse text-[10px] uppercase tracking-[0.2em]">
                          Locking Identity: {mode}
                        </p>
                      </div>
                    ) : (
                      <div className="space-y-4 opacity-10">
                        <ImageIcon className="w-16 h-16 mx-auto" />
                        <p className="text-[10px] uppercase tracking-widest font-bold">9:16 Portrait Canvas</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
              
              <div className="mt-6 text-center">
                 <p className="text-[10px] text-zinc-500 uppercase tracking-[0.3em] font-medium">
                   {resultImage ? `Design ${mode} Ready` : "Ahmad Luxury Studio"}
                 </p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
      `}} />
    </div>
  );
};

export default App;

        
